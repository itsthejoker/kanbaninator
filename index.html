<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Test for Joplin</title>
    <link rel="stylesheet" href="static/vendored/bootstrap.min.css">
    <link rel="stylesheet" href="static/vendored/jkanban.min.css">
    <link rel="stylesheet" href="static/main.css">
</head>
<body class="">

<!-- StartModal -->
<div class="modal modal-lg" id="startModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="startModelLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="startModelLabel">Joplin Kanbaninator</h1>
            </div>
            <div class="modal-body">
                <p>
                    Welcome to Kanbaninator for <a href="https://joplinapp.org/" target="_blank">Joplin</a>!
                    Joplin is a note-taking app that lets you keep complete control of your data, and this
                    app gives you a way to organize some of that data in a kanban-style board while ensuring
                    you keep your data where it should stay: with you.
                </p>
                <p>
                    <strong>Setup:</strong> in Joplin, create an empty notebook that will be your 'base' for
                    the board.
                </p>
                <p>
                    Kanbaninator uses the 'web clipper' service system that's built into Joplin to interact
                    with your notes. On your desktop app, go to <strong>Tools > Options > Web Clipper</strong>,
                    then enable the service if it isn't already enabled. You'll only need one thing here to
                    get started: what is the port number displayed?
                </p>
                <div class="input-group mb-3">
                    <span class="input-group-text" id="joplin_port_number">Port Number</span>
                    <input type="text" class="form-control" aria-label="Sizing example input"
                           aria-describedby="joplin_port_number" value="41184">
                </div>
                <p>
                    You should see a dialogue appear in your Joplin app asking if you want to authorize the
                    Web Clipper connection; click "Grant Authorisation" to get started.
                </p>
                <p style="display: none" id="portNumberError"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="validatePort()">Authenticate</button>
            </div>
        </div>
    </div>
</div>

<!-- FolderModal -->
<div class="modal modal-lg" id="folderModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="folderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="folderModalLabel">What Notebook Are You Working In?</h1>
            </div>
            <div class="modal-body">
                <p>
                    Here are the notebooks we can see. Which notebook is the root notebook for your
                    kanban board?
                </p>
                <p>
                    If we don't detect a configuration note, we'll go ahead and create one.
                </p>
                <ul id="folderList"></ul>
            </div>
        </div>
    </div>
</div>

<!-- TitleModal -->
<div class="modal modal-lg" id="titleModal" tabindex="-1"
     aria-labelledby="titleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="titleModalLabel">Change Board Title</h1>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <span class="input-group-text" id="currentBoardTitle">Title</span>
                    <input type="text" class="form-control" aria-label="Title of the board" id="boardTitleField"
                           aria-describedby="currentBoardTitle">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updateBoardTitle()">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Note Modal -->
<div class="modal modal-lg" id="editNoteModal" tabindex="-1"
     aria-labelledby="editNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="editNoteModalLabel">View / Edit Note</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <span class="input-group-text" id="currentNoteTitle">Title</span>
                    <input type="text" class="form-control" aria-label="Title of the note" id="noteTitleField"
                           aria-describedby="currentNoteTitle">
                </div>
                <div class="form-floating">
                    <div id="currentNoteId" class="d-none"></div>
                    <textarea class="form-control" placeholder="Leave a comment here" id="noteBodyField"
                              style="height: 150px"></textarea>
                    <label for="noteBodyField">Note Body</label>
                </div>
                <hr>
                <div class="text-center">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col1radio" value="col1">
                        <label class="form-check-label col1 colorbox" for="col1radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col2radio" value="col2">
                        <label class="form-check-label col2 colorbox" for="col2radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col3radio" value="col3">
                        <label class="form-check-label col3 colorbox" for="col3radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col4radio" value="col4">
                        <label class="form-check-label col4 colorbox" for="col4radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col5radio" value="col5">
                        <label class="form-check-label col5 colorbox" for="col5radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col6radio" value="col6">
                        <label class="form-check-label col6 colorbox" for="col6radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col7radio" value="col7">
                        <label class="form-check-label col7 colorbox" for="col7radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col8radio" value="col8">
                        <label class="form-check-label col8 colorbox" for="col8radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col9radio" value="col9">
                        <label class="form-check-label col9 colorbox" for="col9radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col10radio" value="col10">
                        <label class="form-check-label col10 colorbox" for="col10radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col11radio" value="col11">
                        <label class="form-check-label col11 colorbox" for="col11radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="colorRadio" id="col12radio" value="col12" checked>
                        <label class="form-check-label col12 colorbox" for="col12radio"></label>
                      </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="deleteNote()">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updateNoteBodyById()">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- New Note Modal -->
<div class="modal modal-lg" id="newNoteModal" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="newNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="newNoteModalLabel">Create Note</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <div id="newNoteBoardId" class="d-none"></div>
                    <span class="input-group-text" id="newNoteTitle">Title</span>
                    <input type="text" class="form-control" aria-label="Title of the note" id="newNoteTitleField"
                           aria-describedby="newNoteTitle">
                </div>
                <div class="form-floating">
                    <textarea class="form-control" placeholder="Leave a comment here" id="newNoteBodyField"
                              style="height: 150px"></textarea>
                    <label for="newNoteBodyField">Note Body</label>
                </div>
                <div class="text-center mt-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol1radio" value="col1">
                        <label class="form-check-label col1 colorbox" for="ncol1radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol2radio" value="col2">
                        <label class="form-check-label col2 colorbox" for="ncol2radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol3radio" value="col3">
                        <label class="form-check-label col3 colorbox" for="ncol3radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol4radio" value="col4">
                        <label class="form-check-label col4 colorbox" for="ncol4radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol5radio" value="col5">
                        <label class="form-check-label col5 colorbox" for="ncol5radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol6radio" value="col6">
                        <label class="form-check-label col6 colorbox" for="ncol6radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol7radio" value="col7">
                        <label class="form-check-label col7 colorbox" for="ncol7radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol8radio" value="col8">
                        <label class="form-check-label col8 colorbox" for="ncol8radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol9radio" value="col9">
                        <label class="form-check-label col9 colorbox" for="ncol9radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol10radio" value="col10">
                        <label class="form-check-label col10 colorbox" for="ncol10radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol11radio" value="col11">
                        <label class="form-check-label col11 colorbox" for="ncol11radio"></label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="newColorRadio" id="ncol12radio" value="col12" checked>
                        <label class="form-check-label col12 colorbox" for="ncol12radio"></label>
                      </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="add_item()">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- New Premade Modal -->
<div class="modal modal-lg" id="newPremadeModal" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="newPremadeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="newPremadeModalLabel">Starting Template</h1>
            </div>
            <div class="modal-body">
                <p>
                    Here are some premade story beats that you can use to get started! Select whichever
                    suits your fancy.
                </p>
                <div class="d-grid gap-2">
                    <div class="btn btn-primary" onclick="templateHerosJourney()">The Hero's Journey</div>
                    <div class="btn btn-primary" onclick="templateThreeActStructure()">Three-Act Structure</div>
                    <div class="btn btn-primary" onclick="templateSaveTheCat()">Save the Cat</div>
                    <div class="btn btn-primary" onclick="templateRomancingTheBeat()">Romancing the Beat</div>
                    <div class="btn btn-primary" onclick="templateJamiGoldRomanceBeats()">Jami Gold's Romance Beats</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <h1 id="boardTitle" class="text-center pt-4" onclick="showTitleModal()" style="cursor: pointer;">...</h1>
    <div class="text-center">
        <div id="kanbanBoard" class="container py-5"></div>
    </div>
</div>

<script type="module" src="static/main.js"></script>

<script src="static/vendored/axios.min.js"></script>
<script src="static/vendored/bootstrap.min.js"></script>
<script src="static/vendored/jkanban.min.js"></script>
<script src="static/vendored/dom-autoscroller.min.js"></script>

<script type="application/javascript">

    function showSpinner() {
        document.getElementById("loadingSpinner").style.display = 'block'
    }

    function hideSpinner() {
        document.getElementById("loadingSpinner").style.display = 'none'
    }

    function validatePort() {
        let port_number = document.getElementById("joplin_port_number").nextElementSibling.value;
        if (!(window.isNaN(port_number))) {
            window.port_number = port_number;
            startLogin()
        } else {
            let errorp = document.getElementById("portNumberError");
            errorp.style.display = 'block';
            errorp.textContent = "That's not a number. Please put in a port number."
            window.startModal.show();
        }
    }

    function setProjectUrl() {
        const url = new URL(window.location.href);
        url.searchParams.set('configNoteId', window.configNoteId);
        url.searchParams.set('rootFolder', window.rootFolder);
        window.history.pushState({}, '', url);
    }

    function saveBoardState() {
        let boardState = JSON.stringify(renderJSON(), null, 2);
        boardState = (
            "Quick link: https://itsthejoker.github.io/kanbaninator/?configNoteId=" + window.configNoteId + "&rootFolder=" + window.rootFolder
            + "\n\n"
            + "```json\n"
            + boardState
            + "\n```\n\n"
            + "This note is automatically maintained by [Kanbaninator](https://itsthejoker.github.io/kanbaninator/)."
        );
        axios.put(`http://127.0.0.1:${window.port_number}/notes/${window.configNoteId}?token=${window.token}`, {body: boardState})
    }

    function createListElement(obj) {
        let newListItem = document.createElement("li");
        let newListItemButton = document.createElement('span');
        let itemTitle = document.createElement('span');
        newListItemButton.classList.add('badge', 'bg-primary', 'me-2', 'text-white');
        newListItemButton.onclick = selectFolder;
        newListItemButton.innerText = 'Select';
        newListItemButton.style.cursor = 'pointer'
        newListItem.setAttribute('data-joplin-id', obj.id);
        newListItem.setAttribute('data-joplin-parent-id', obj.parent_id);
        itemTitle.textContent = obj.title;
        newListItem.appendChild(newListItemButton);
        newListItem.appendChild(itemTitle);
        return newListItem;
    }

    function buildTemplate(templateData) {
        window.config = {title: "My Story", data: []};
        templateData.forEach((title) => {
            window.config.data.push({
                "id": crypto.randomUUID(),
                "title": title,
                "item": []
            })
        })
        buildKanbanBoard();
        window.premadeModal.hide();
        saveBoardState();
    }

    function templateHerosJourney() {
        buildTemplate([
            "Call to Adventure",
            "Refusal of Call",
            "Supernatural Aid/Mentor",
            "Road of Trials",
            "Crossing the Threshold",
            "Death of Mentor",
            "Ordeal",
            "Temptation",
            "Battle with the Brother",
            "Refusal to Return",
            "Road Back",
            "Master of Two Worlds",
            "Ultimate Reward",
        ])
    }

    function templateRomancingTheBeat() {
        buildTemplate([
            "Setup: Introduce H1",
            "Introduce H2",
            "Meet Cute",
            "No Way 1",
            "Adhesion",
            "Falling in Love: No Way 2",
            "Inkling of Desire",
            "Deepening Desire",
            "Maybe This Could Work",
            "Midpoint of Love",
            "Retreating from Love: Inkling of Doubt",
            "Deepening Doubt",
            "Retreat Beat",
            "Shields Up",
            "Break Up",
            "Fighting for Love: Dark Night",
            "Wake Up",
            "Grand Gesture",
            "What Whole-Hearted Looks Like",
            "Epilogue"
        ])
    }

    function templateThreeActStructure() {
        buildTemplate([
            "Act 1: Beginning",
            "Inciting Incident",
            "Second Thoughts",
            "Climax of Act 1",
            "Act 2: Obstacle",
            "Obstacle 2",
            "Midpoint (Big Twist)",
            "Obstacle 3",
            "Disaster",
            "Crisis",
            "Climax of Act 2",
            "Act 3: Climax",
            "Wrap-up",
            "End"
        ])
    }

    function templateSaveTheCat() {
        buildTemplate([
            "Act 1: Opening Image",
            "Theme Stated",
            "Set-up",
            "Catalyst",
            "Debate",
            "Act 2: B Story",
            "Fun and Games",
            "Midpoint",
            "Bad Guys Close In",
            "All is Lost",
            "Dark Night of the Soul",
            "Act 3: Finale",
            "Final Image"
        ])
    }

    function templateJamiGoldRomanceBeats() {
        buildTemplate([
            "Act 1: Opening Hook",
            "Inciting Incident",
            "End of the Beginning",
            "Act 2: Pinch Point 1",
            "Midpoint",
            "Pinch Point 2",
            "Crisis",
            "Act 3: Climax",
            "Final Resolution"
        ])
    }

    function populateFolderModal() {
        const bigList = document.getElementById("folderList");
        let folderArray = [...window.folders];

        while (folderArray.length) {
            folderArray.forEach((folder) => {
                if (folder.parent_id === '') {
                    bigList.appendChild(createListElement(folder))
                    folderArray = folderArray.filter(temp => temp.id !== folder.id);
                } else {
                    try {
                        let target = document.querySelector(`[data-joplin-id="${folder.parent_id}"]`);
                        let newUL = document.createElement('ul');
                        newUL.appendChild(createListElement(folder));
                        target.appendChild(newUL);
                        folderArray = folderArray.filter(temp => temp.id !== folder.id);
                    } catch (error) {
                        // continue, we'll pass it on the next iteration
                    }
                }
            })
        }
    }

    function spawnTitlePrompt(boardId) {
        document.getElementById("newNoteTitleField").value = "";
        document.getElementById("newNoteBodyField").value = "";
        document.getElementById("newNoteBoardId").textContent = boardId;
        window.newNoteModal.show()
    }

    function deleteNote() {
        let noteId = document.getElementById('currentNoteId').textContent;
        if (confirm("Delete this note?") === true) {
            axios.delete(
                `http://127.0.0.1:${window.port_number}/notes/${noteId}?token=${window.token}`
            ).then(function (response) {
                window.kanban.removeElement(noteId);
                console.log(`Deleted note ${noteId}`);
                window.editModal.hide()
            })
        }
    }

    function apply_colors() {
        Array.from(document.getElementsByClassName("kanban-item")).forEach(el => {
            let colorClass = el.dataset.colorclass;
            el.classList.remove(...colorClassValues);
            el.classList.add(colorClass);
        })
    }

    function add_item() {
        window.newNoteModal.hide();
        let title = document.getElementById("newNoteTitleField").value;
        let body = document.getElementById("newNoteBodyField").value;
        let boardId = document.getElementById("newNoteBoardId").textContent;
        

        let postData = {
            parent_id: window.rootFolder,
            title: title,
            body: body
        }

        let colorClass = "";

        Array.from(document.getElementsByName("newColorRadio")).forEach(function (el) {
            if (el.checked) {
                colorClass = el.value;
            }
        })

        axios.post(
            `http://127.0.0.1:${window.port_number}/notes?token=${window.token}`,
            postData
        ).then(function (response) {
            window.kanban.addElement(boardId, {
                title: title,
                id: response.data.id,
                colorclass: colorClass
            });
            apply_colors();
            saveBoardState();
            console.log(`Created note ${response.data.id}`);
        })
    }

    function renderJSON() {
        let title = document.getElementById("boardTitle").textContent;
        let boards = []
        document.querySelectorAll('.kanban-board').forEach(el => {
            let item = []
            el.querySelectorAll('.kanban-item').forEach(i => {
                item.push({
                    title: i.childNodes[0].textContent,
                    id: i.dataset.eid,
                    colorClass: i.dataset.colorclass
                })
            })
            boards.push({
                id: el.getAttribute('data-id'),
                title: el.querySelector('.kanban-title-board').innerHTML,
                item,
            })
        })
        return {
            title: title,
            data: boards
        }
    }

    function buildKanbanBoard() {
        document.getElementById("boardTitle").textContent = window.config.title;
        window.kanban = new jKanban({
            element: '#kanbanBoard',
            boards: window.config.data,
            dragBoards: false,
            // responsivePercentage: true,
            click: function (el) {
                getNoteBodyById(el.dataset.eid);
            },
            dropEl: function (el, target, source, sibling) {
                saveBoardState();
            },
            dragendBoard: function (el) {
                saveBoardState();
            },
            itemAddOptions: {
                enabled: true,                                              // add a button to board for easy item creation
                content: '+',                                                // text or html content of the board button
                class: 'button-add-item btn kanban-title-button text-white btn-xs',         // default class of the button
                footer: false                                                // position the button on footer
            },
        })

        autoScroll([
                this
            ],{
                margin: 100,
                maxSpeed: 50,
                scrollWhenOutside: true,
                autoScroll: function(){
                    //Only scroll when the pointer is down, and there is a child being dragged.
                    return this.down && window.kanban.drake.dragging;
                }
            }
        );

        Array.from(document.getElementsByClassName("button-add-item")).forEach(el => {
            el.addEventListener("click", function () {
                spawnTitlePrompt(el.parentElement.parentElement.dataset.id);
            });
            moveElementUp(el);
        });
        apply_colors();
        rowatize();
    }

    function getConfigNote() {
        axios.get(
            `http://127.0.0.1:${window.port_number}/notes/${window.configNoteId}?token=${window.token}&fields=body`
        )
            .then(function (response) {
                try {
                    window.config_note = response.data.body;
                    window.config_note = window.config_note.split('\n');
                    const firstIndex = window.config_note.findIndex(element => element === '```json');
                    const lastIndex = window.config_note.findLastIndex(element => element === '```');
                    let data = window.config_note.slice(firstIndex + 1, lastIndex).join('');
                    window.config = JSON.parse(data);
                    buildKanbanBoard();
                    console.log("Found existing config & built board.");
                    window.folderModal.hide();
                    setCookies();
                    setProjectUrl();
                } catch (error) {
                    console.log("Found config, but cannot load. Error:");
                    console.log(error)
                }
            })
    }
    
    function showTitleModal() {
        window.titleModal.show();
    }

    function hideTitleModal() {
        window.titleModal.hide();
    }

    function updateBoardTitle () {
        let newTitle = document.getElementById("boardTitleField").value;
        document.getElementById("boardTitle").textContent = newTitle;
        window.config.title = newTitle;
        saveBoardState();
        hideTitleModal();
    }

    function uncheckAllRadios() {
        Array.from(document.getElementsByName("colorRadio")).forEach(function (el) {
            el.checked = false;
        })
        Array.from(document.getElementsByName("newColorRadio")).forEach(function (el) {
            el.checked = false;
        })
        
    }

    function getNoteBodyById(noteId) {
        axios.get(
            `http://127.0.0.1:${window.port_number}/notes/${noteId}?token=${window.token}&fields=body,title`
        )
            .then(function (response) {
                try {
                    document.getElementById('currentNoteId').textContent = noteId;
                    document.getElementById('noteTitleField').value = response.data.title;
                    document.getElementById('noteBodyField').value = response.data.body;
                    let currentColor = document.querySelector(`[data-eid="${noteId}"]`).dataset.colorclass;
                    if (currentColor === undefined) {
                        currentColor = "col12";
                    }
                    uncheckAllRadios();
                    document.getElementById(currentColor + "radio").checked = true;
                    document.getElementById("n" + currentColor + "radio").checked = true;
                    window.editModal.show();
                } catch (error) {
                    console.log(`Found requested note ${noteId}, but cannot load body. Error:`);
                    console.log(error)
                }
            })
    }

    function updateNoteBodyById() {
        let noteId = document.getElementById('currentNoteId').textContent;
        let noteTitle = document.getElementById('noteTitleField').value;
        axios.put(
            `http://127.0.0.1:${window.port_number}/notes/${noteId}?token=${window.token}`,
            {
                body: document.getElementById('noteBodyField').value,
                title: noteTitle
            }
        );
        let currentNote = document.querySelector(`[data-eid="${noteId}"]`);
        if (currentNote.textContent !== noteTitle) {
            currentNote.textContent = noteTitle
        }
        Array.from(document.getElementsByName("colorRadio")).forEach(function (el) {
            if (el.checked) {
                currentNote.classList.remove(...colorClassValues);
                currentNote.classList.add(el.value);
                currentNote.dataset.colorclass = el.value;
            }
        })
        apply_colors();
        window.editModal.hide();
        console.log(`Edited note ${noteId}`);
        saveBoardState();
    }

    function selectFolder() {
        window.rootFolder = this.parentElement.dataset.joplinId
        axios.get(
            `http://127.0.0.1:${window.port_number}/folders/${window.rootFolder}/notes?token=${window.token}`
        )
            .then(function (response) {
                response.data.items.forEach((note) => {
                    if (note.title === ".kanbaninator") {
                        window.configNoteId = note.id;
                        getConfigNote();
                    }
                });
                if (window.configNoteId === undefined) {
                    // we didn't find a config note in this folder.
                    let postData = {
                        parent_id: window.rootFolder,
                        title: ".kanbaninator",
                        body: ""
                    }

                    axios.post(
                        `http://127.0.0.1:${window.port_number}/notes?token=${window.token}`,
                        postData
                    ).then(function (response) {
                        window.configNoteId = response.data.id;
                    })
                    window.folderModal.hide();
                    window.premadeModal.show();
                }
            })
    }

    function finishSetup() {
        axios.get(`http://127.0.0.1:${window.port_number}/auth/check?auth_token=${window.auth_token}`)
            .then(function (response) {
                if (response.data.status === "waiting") {
                    return
                } else {
                    window.token = response.data.token;
                    getFolders();
                    hideSpinner();
                    window.folderModal.show();
                    clearInterval(window.getKeyInterval);
                }
            })
    }

    function startLogin() {
        axios.post(`http://127.0.0.1:${window.port_number}/auth`)
            .then(function (response) {
                // handle success
                console.log(`auth success, received key ${response.data.auth_token}`);
                window.auth_token = response.data.auth_token;
                window.startModal.hide();
                showSpinner();
                window.getKeyInterval = setInterval(finishSetup, 500)
            })
            .catch(function (error) {
                console.log(error);
                let errorp = document.getElementById("portNumberError");
                errorp.style.display = 'block';
                errorp.textContent = "Something went wrong; is that the right port? Alternatively, is Web Clipper enabled?"
                window.startModal.show();
            })
    }

    function getFolders() {
        // we may enter this with an invalid token, so we need to check for that.
        axios.get(`http://127.0.0.1:${window.port_number}/folders?token=${window.token}`)
            .then(function (response) {
                window.folders = response.data.items;
                populateFolderModal()
            })
            .catch(function (error) {
                // we got an invalid token, so restart from the auth flow
                window.startModal.show();
            })
    }
    
    function rowatize() {
        let board = document.getElementsByClassName("kanban-container")[0];
        board.classList.add("row", "g-2");
        board.style.width = "";
        Array.from(document.getElementsByClassName("kanban-board")).forEach(el => {
            el.classList.add("col-12", "col-md-6", "col-lg-4", "col-xl-3", "p-3");
            el.style.width = "";
            el.style.margin = "0";
            el.style.paddingLeft = "0";
            el.style.paddingRight = "0";
        })
    }

    document.addEventListener("DOMContentLoaded", function (event) {
        window.startModal = new bootstrap.Modal(document.getElementById('startModal'));
        window.folderModal = new bootstrap.Modal(document.getElementById('folderModal'));
        window.editModal = new bootstrap.Modal(document.getElementById('editNoteModal'));
        window.newNoteModal = new bootstrap.Modal(document.getElementById('newNoteModal'));
        window.premadeModal = new bootstrap.Modal(document.getElementById('newPremadeModal'));
        window.titleModal = new bootstrap.Modal(document.getElementById('titleModal'));

        const joplinToken = getCookie("joplinToken");
        const joplinPort = getCookie("joplinPort");
        const params = new URLSearchParams(window.location.search);
        console.log(joplinToken, joplinPort, params.get("configNoteId"));
        if (joplinToken && joplinPort) {
            window.token = joplinToken;
            window.port_number = joplinPort;

            if (params.get("configNoteId")) {
                window.rootFolder = params.get("rootFolder");
                window.configNoteId = params.get("configNoteId");
                getFolders();
                getConfigNote();
                return
            }

            getFolders();
            window.folderModal.show();
        } else {
            window.startModal.show();
        }
    });
</script>
</body>
</html>
